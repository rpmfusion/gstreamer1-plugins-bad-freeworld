From e95a1aa3521e0f82609f5fc45751c3171ccf5f64 Mon Sep 17 00:00:00 2001
From: Rui Chen <rui@chenrui.dev>
Date: Sat, 23 Nov 2024 19:45:54 +0000
Subject: [PATCH] [x265enc] Fix mastering display color volume assignment

upstream change ref, https://bitbucket.org/multicoreware/x265_git/commits/451add89e81d45134b9d41168ceeb5516bf62d0b

relates to https://github.com/Homebrew/homebrew-core/pull/198642

Signed-off-by: Rui Chen <rui@chenrui.dev>
---
 .../gst-plugins-bad/ext/x265/gstx265enc.c     | 30 ++++++++++---------
 1 file changed, 16 insertions(+), 14 deletions(-)

diff --git a/ext/x265/gstx265enc.c b/ext/x265/gstx265enc.c
index e6aa973ac7cc..db85b1b806ca 100644
--- a/ext/x265/gstx265enc.c
+++ b/ext/x265/gstx265enc.c
@@ -942,20 +942,22 @@ gst_x265_enc_init_encoder_locked (GstX265Enc * encoder)
 
     if (gst_video_mastering_display_info_from_caps (&minfo,
             encoder->input_state->caps)) {
-      GST_DEBUG_OBJECT (encoder, "Apply mastering display info");
-
-      /* GstVideoMasteringDisplayInfo::display_primaries is rgb order but
-       * HEVC uses gbr order
-       * See spec D.3.28 display_primaries_x and display_primaries_y
-       */
-      encoder->x265param.masteringDisplayColorVolume =
-          g_strdup_printf ("G(%hu,%hu)B(%hu,%hu)R(%hu,%hu)WP(%hu,%hu)L(%u,%u)",
-          minfo.display_primaries[1].x, minfo.display_primaries[1].y,
-          minfo.display_primaries[2].x, minfo.display_primaries[2].y,
-          minfo.display_primaries[0].x, minfo.display_primaries[0].y,
-          minfo.white_point.x, minfo.white_point.y,
-          minfo.max_display_mastering_luminance,
-          minfo.min_display_mastering_luminance);
+        GST_DEBUG_OBJECT (encoder, "Apply mastering display info");
+
+        /* GstVideoMasteringDisplayInfo::display_primaries is rgb order but
+        * HEVC uses gbr order
+        * See spec D.3.28 display_primaries_x and display_primaries_y
+        */
+
+        g_snprintf(encoder->x265param.masteringDisplayColorVolume,
+                  X265_MAX_STRING_SIZE,
+                  "G(%hu,%hu)B(%hu,%hu)R(%hu,%hu)WP(%hu,%hu)L(%u,%u)",
+                  minfo.display_primaries[1].x, minfo.display_primaries[1].y,
+                  minfo.display_primaries[2].x, minfo.display_primaries[2].y,
+                  minfo.display_primaries[0].x, minfo.display_primaries[0].y,
+                  minfo.white_point.x, minfo.white_point.y,
+                  minfo.max_display_mastering_luminance,
+                  minfo.min_display_mastering_luminance);
     }
 
     if (gst_video_content_light_level_from_caps (&cll,
-- 
GitLab

